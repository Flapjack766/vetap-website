# ูุธุงู ุงูุชูุงุก ูุฏุฉ ุงูููุฒุฑ ุงููุฎุตุต - ุงููุฑุญูุฉ 7

## โ ูุง ุชู ุฅูุฌุงุฒู

ุชู ุชูููุฐ ูุธุงู ูุงูู ูุฅุฏุงุฑุฉ ุงูุชูุงุก ูุฏุฉ ุงูููุฒุฑุงุช ุงููุฎุตุตุฉ ุชููุงุฆูุงู.

### 1. ุชุญุฏูุซ ุตูุญุฉ ุงูุจุฑููุงูู ุงูุนุงู (`/p/[slug]`)

**ุงูููู**: `app/[locale]/p/[slug]/page.tsx`

- โ ุงูุชุญูู ูู ุงูุชูุงุก ูุฏุฉ `custom_username_expires_at` ูุจู ุงุณุชุฎุฏุงู `username_custom`
- โ ุฅุฐุง ุงูุชูุช ุงููุฏุฉุ ูุชุฌุงูู `username_custom` ููุจุญุซ ุนู `username_random` ุจุฏูุงู ููู
- โ ุฅุฐุง ูู ุชูุชูู ุงููุฏุฉุ ูุณุชุฎุฏู `username_custom` ุจุดูู ุทุจูุนู

### 2. ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูููู**: `supabase/add-custom-username-expired-flag.sql`

- โ ุฅุถุงูุฉ ุญูู `custom_username_expired` (BOOLEAN) ูู ุฌุฏูู `profiles`
- โ ุฅูุดุงุก indexes ูุชุญุณูู ุงูุฃุฏุงุก
- โ ุฅูุดุงุก ุฏุงูุฉ `check_expired_custom_usernames()` ููุชุญูู ูู ุงูุจุฑููุงููุงุช ุงูููุชููุฉ ูุชุญุฏูุซูุง

### 3. API Route ููุชุญูู ูู ุงูุจุฑููุงููุงุช ุงูููุชููุฉ

**ุงูููู**: `app/api/cron/check-expired-usernames/route.ts`

- โ ุงุณุชุฏุนุงุก ุฏุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุชุญูู ูู ุงูุจุฑููุงููุงุช ุงูููุชููุฉ
- โ ุฅุฑุณุงู ุฅููููุงุช ูููุณุชุฎุฏููู ุงูุฐูู ุงูุชูุช ูุฏุฉ ููุฒุฑุงุชูู ุงููุฎุตุตุฉ
- โ ุญูุงูุฉ ุงูู endpoint ุจู `CRON_SECRET`
- โ ุฏุนู GET ู POST methods

### 4. Cron Job Configuration

**ุงููููุงุช**:
- `vercel.json` - ุฅุนุฏุงุฏ Vercel Cron (ูุนูู ููููุงู ูู ููุชุตู ุงูููู UTC)
- `CRON_SETUP.md` - ุฏููู ุดุงูู ูุฅุนุฏุงุฏ cron job ูู ูุฎุชูู ุงูุฎุฏูุงุช

### 5. ุชุญุฏูุซ ุงูุฃููุงุน (TypeScript)

**ุงูููู**: `lib/supabase/types.ts`

- โ ุฅุถุงูุฉ `custom_username_expired` ูู ุฃููุงุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฅุถุงูุฉ ููุน ููุฏุงูุฉ `check_expired_custom_usernames`

## ๐ ุงูุฎุทูุงุช ุงููุทููุจุฉ ููุชุดุบูู

### 1. ุชุดุบูู Migration

```sql
-- ูู ุจุชุดุบูู ูุฐุง ุงูููู ูู Supabase SQL Editor
supabase/add-custom-username-expired-flag.sql
```

### 2. ุฅุถุงูุฉ ูุชุบูุฑุงุช ุงูุจูุฆุฉ

ุฃุถู ูู `.env.local`:

```env
CRON_SECRET=your-secret-token-here-change-this-to-strong-random-token
```

### 3. ุฅุนุฏุงุฏ Cron Job

ุฑุงุฌุน ููู `CRON_SETUP.md` ููุชูุงุตูู ุงููุงููุฉ. ุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ:

- **Vercel Cron** (ููุตู ุจู) - ูุนูู ุชููุงุฆูุงู ูุน `vercel.json`
- **GitHub Actions** - ููู repositories ุนูู GitHub
- **External Cron Service** - ูุซู cron-job.org
- **Supabase Edge Function** - ุฅุฐุง ููุช ุชูุถู ุงุณุชุฎุฏุงู Supabase

## ๐ ููู ูุนูู ุงููุธุงู

### ุนูุฏ ุฒูุงุฑุฉ ุตูุญุฉ `/p/[slug]`:

1. ุงููุธุงู ูุจุญุซ ุฃููุงู ุนู ุจุฑููุงูู ุจู `username_custom = slug`
2. ุฅุฐุง ููุฌุฏ:
   - ูุชุญูู ูู `custom_username_expires_at`
   - ุฅุฐุง `expiresAt <= now`: ูุชุฌุงูู `username_custom` ููุจุญุซ ุนู `username_random`
   - ุฅุฐุง `expiresAt > now`: ูุณุชุฎุฏู `username_custom` ุจุดูู ุทุจูุนู
3. ุฅุฐุง ูู ูููุฌุฏ `username_custom` ุฃู ุงูุชูุช ูุฏุฉุ ูุจุญุซ ุนู `username_random`

### ุนูุฏ ุชุดุบูู Cron Job (ููููุงู):

1. ูุณุชุฏุนู `check_expired_custom_usernames()` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. ุงูุฏุงูุฉ:
   - ุชุญุฏูุซ `custom_username_expired = TRUE` ููุจุฑููุงููุงุช ุงูููุชููุฉ
   - ุชุฑุฌุน ูุงุฆูุฉ ุจุงูุจุฑููุงููุงุช ุงูููุชููุฉ ุญุฏูุซุงู
3. API route ูุฑุณู ุฅูููู ููู ูุณุชุฎุฏู ูุฏูู ุจุฑููุงูู ููุชูู
4. ุงูุฅูููู ูุฎุจุฑ ุงููุณุชุฎุฏู ุจุฃู ูุฏุฉ ุงูููุฒุฑ ุงููุฎุตุต ุงูุชูุช ูููููู ุทูุจ ูุงุญุฏ ุฌุฏูุฏ

## ๐ง ูุญุชูู ุงูุฅูููู

ุงูุฅูููู ูุญุชูู ุนูู:
- ุชูุจูู ุจุฃู ูุฏุฉ ุงูููุฒุฑ ุงููุฎุตุต ุงูุชูุช
- ุชุงุฑูุฎ ุงูุงูุชูุงุก
- ุฑุงุจุท ุฅูู ููุญุฉ ุงูุชุญูู ูุทูุจ ููุฒุฑ ูุฎุตุต ุฌุฏูุฏ
- ุฏุนู ููุบุฉ ุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ

## ๐ ุงูุฃูุงู

- **CRON_SECRET**: ูุฌุจ ุฃู ูููู token ููู ูุญูุงูุฉ ุงูู endpoint
- ูููู ุงุณุชุฎุฏุงู Authorization header ุฃู query parameter
- ุงูู endpoint ูุญูู ูู ุงูุงุณุชุฎุฏุงู ุบูุฑ ุงููุตุฑุญ ุจู

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ูุฏูู:

```bash
curl -X GET "http://localhost:7000/api/cron/check-expired-usernames?secret=your-secret-token"
```

### ุงุฎุชุจุงุฑ ูู Supabase:

```sql
-- ุงุฎุชุจุงุฑ ุงูุฏุงูุฉ
SELECT * FROM check_expired_custom_usernames();

-- ุงูุชุญูู ูู ุงูุจุฑููุงููุงุช ุงูููุชููุฉ
SELECT 
  id,
  username_custom,
  custom_username_expires_at,
  custom_username_expired
FROM profiles
WHERE username_custom IS NOT NULL
  AND custom_username_expires_at IS NOT NULL
  AND custom_username_expires_at <= NOW();
```

## ๐ ุงููุชูุฌุฉ

โ ุงููุธุงู ูุฏูุฑ ุชุงุฑูุฎ ุงูุงูุชูุงุก ุชููุงุฆูุงู ุจุฏูู ุชุฏุฎู ูุฏูู ูููู
โ ุงููุณุชุฎุฏููู ูุชูููู ุฅุดุนุงุฑุงุช ุนูุฏ ุงูุชูุงุก ูุฏุฉ ููุฒุฑุงุชูู
โ ุงูุจุฑููุงููุงุช ุงูููุชููุฉ ุชูุญุฏูุซ ุชููุงุฆูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ ุงูุตูุญุงุช ุงูุนุงูุฉ ุชุชุญูู ูู ุงูุชูุงุก ุงููุฏุฉ ุชููุงุฆูุงู

## ๐ ููุงุญุธุงุช

- ุงููุธุงู ูุนูู ุชููุงุฆูุงู ุจุฏูู ุชุฏุฎู ูุฏูู
- ุงูุฅููููุงุช ุงุฎุชูุงุฑูุฉ (ูููู ุชุนุทูููุง ุจุชุนููู ุงูููุฏ)
- ูููู ุชุฎุตูุต ุชูููุช ุงูู cron ุญุณุจ ุงุญุชูุงุฌุงุชู
- ูููู ุฅุถุงูุฉ ุฅุดุนุงุฑุงุช ุฅุถุงููุฉ (SMSุ Push notificationsุ ุฅูุฎ)

